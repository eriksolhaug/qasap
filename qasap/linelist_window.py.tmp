class SpectrumPlotterApp(QWidget):
    def __init__(self, plotter):
        super().__init__()
        self.plotter = plotter
        self.init_ui()

    def init_ui(self):
        self.setWindowTitle("QASAP - Quick Analysis of Spectra and Profiles (v0.5)")
        layout = QVBoxLayout()

        # File input
        self.file_label = QLabel("FITS File Path:")
        self.file_input = QLineEdit()
        self.file_input.setText(self.plotter.fits_file)
        layout.addWidget(self.file_label)
        layout.addWidget(self.file_input)

        # Redshift input
        self.redshift_label = QLabel("Redshift:")
        self.redshift_input = QLineEdit(str(self.plotter.redshift))
        layout.addWidget(self.redshift_label)
        layout.addWidget(self.redshift_input)

        # Zoom factor input
        self.zoom_label = QLabel("Zoom Factor:")
        self.zoom_input = QLineEdit(str(self.plotter.zoom_factor))
        layout.addWidget(self.zoom_label)
        layout.addWidget(self.zoom_input)

        # File flag input
        self.flag_label = QLabel("File Flag (0, 1, or 2):")
        self.flag_input = QLineEdit(str(self.plotter.file_flag))
        layout.addWidget(self.flag_label)
        layout.addWidget(self.flag_input)

        # Plot button
        self.plot_button = QPushButton("Plot Spectrum")
        self.plot_button.clicked.connect(self.on_plot)
        layout.addWidget(self.plot_button)

        self.setLayout(layout)

    def on_plot(self):
        # Update plotter attributes from GUI inputs
        self.plotter.fits_file = self.file_input.text()
        self.plotter.redshift = float(self.redshift_input.text())
        self.plotter.zoom_factor = float(self.zoom_input.text())
        self.plotter.file_flag = int(self.flag_input.text())

        # Call the plotting function
        self.plotter.plot_spectrum()

class LineListWindow(QtWidgets.QWidget):
    selected_line = QtCore.pyqtSignal(str, float)  # Signal to emit the selected line wavelength
    closed = pyqtSignal()  # Define a custom signal for when the window closes

    def __init__(self, line_wavelengths, line_ids):
        super().__init__()
        self.line_wavelengths = line_wavelengths
        self.line_ids = line_ids
        self.init_ui()

    def closeEvent(self, event):
        self.closed.emit()  # Emit the signal when the window closes
        event.accept()  # Accept the close event to proceed with closing

    def init_ui(self):
        self.setWindowTitle("Line List")
        self.setGeometry(100, 100, 300, 400)

        # Create a list widget to display lines
        self.list_widget = QtWidgets.QListWidget(self)
        for line_id, wavelength in zip(self.line_ids, self.line_wavelengths):
            self.list_widget.addItem(f"{line_id}: {wavelength:.2f}")

        self.list_widget.itemDoubleClicked.connect(self.item_selected)

        # Layout
        layout = QtWidgets.QVBoxLayout()
        layout.addWidget(self.list_widget)
        self.setLayout(layout)

    def item_selected(self, item):
        # Extract the selected wavelength from the item text
        text = item.text()
        line_id = text.split(': ')[0]  # Get the line ID
        wavelength = float(text.split(': ')[1].split()[0])  # Get the wavelength in AA
        self.selected_line.emit(line_id, wavelength)  # Emit the signal with the selected wavelength
        self.close()  # Close the window after selection

def main():
    # Parse command-line arguments
    parser = argparse.ArgumentParser(description='QASAP - Quick Analysis of Spectra and Profiles (v0.1)')
    parser.add_argument('fits_file', type=str, nargs='?', help='Path to the spectrum (FITS) file')
    parser.add_argument('--redshift', type=float, default=0.0, help='Initial redshift value (default: 0.0)')
    parser.add_argument('--zoom_factor', type=float, default=0.1, help='Initial zoom factor (default: 0.1)')
    parser.add_argument('--file_flag', type=int, default=0, help='File flag (default: 0)')
    parser.add_argument('--lsf', type=str, default="10", help='Line spread function: float width in km/s or path to LSF file')
    parser.add_argument('--gui', action='store_true', help='Launch the GUI for interactive input')
    parser.add_argument('--alfosc', action='store_true', help='Load ALFOSC 2D spectrum and wavelength solution to yield 1D spectrum')
    parser.add_argument('--alfosc_bin', type=int, help='ALFOSC desired 1D binning in Angstroms')
    parser.add_argument('--alfosc_left', type=int, help="Left x-bound (inclusive)")
    parser.add_argument('--alfosc_right', type=int, help="Right x-bound (exclusive)")
    parser.add_argument('--alfosc_output',type=str, help="Path to save extracted 1D spectrum as text file")
    args = parser.parse_args()

    # Initialize QApplication (importantly, initialize this before the SpectrumPlotter)
    # ... and ensure a QApplication is running
    if not QtWidgets.QApplication.instance():
        app = QtWidgets.QApplication(sys.argv)
    else:
        app = QtWidgets.QApplication.instance()

    # Launch the GUI if the --gui flag is used
    if args.gui:
        plotter = SpectrumPlotter(args.fits_file, args.redshift, args.zoom_factor, args.file_flag)
        opener_window = SpectrumPlotterApp(plotter)
        opener_window.show()

    print("alfosc:", args.alfosc)# DEBUG
    # Handle file processing from command line if not using the GUI
    if args.fits_file:
        print(f"Opening file: {args.fits_file}")
        plotter = SpectrumPlotter(args.fits_file, args.redshift, args.zoom_factor, args.file_flag, args.alfosc, args.alfosc_bin, args.alfosc_left, args.alfosc_right, args.alfosc_output)
        plotter.plot_spectrum()
    else:
        print("No FITS file provided. Please specify a file or use the GUI.")
        sys.exit(1)  # Exit with an error code if no file is specified

    # Close the Qt
    sys.exit(app.exec_())  # Call exec_ only once at the end

if __name__ == '__main__':
    main()
